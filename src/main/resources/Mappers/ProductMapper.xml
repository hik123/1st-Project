<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.exproject.product.ProductMapper">
    <!-- 장바구니 목록 추가 -->
    <insert id="insProduct" useGeneratedKeys="true" keyProperty="productPk">
        INSERT INTO t_purchase_product
        SET user_pk = #{userPk}
        , category_pk = #{categoryPk}
        , product_nm = #{productNm}
        <if test=" memo != '' and memo != null ">
            , memo = #{memo}
        </if>
    </insert>

    <!-- 장바구니 목록 보기 -->
    <select id="selProduct">
        SELECT
              A.product_pk AS productPk
            , B.category_nm AS categoryNm
            , A.product_nm AS purchaseNm
            , A.memo
            , A.created_at AS createdAt
            , A.updated_at AS updatedAt
            , A.buying_check AS buyingCheck
            , A.buying_date AS buyingDate
        FROM t_purchase_product A
        JOIN t_category B
        ON A.category_pk = B.category_pk
        WHERE A.user_pk = #{userPk}
        <choose>
            <when test="isList == 0">
                AND A.buying_check <![CDATA[<]]> 2
            </when>
            <when test="isList == 1">
                AND A.buying_check = 0 <!-- 구매 할 목록 -->
            </when>
            <when test="isList == 2">
                AND A.buying_check = 1 <!-- 구매 확정 목록-->
            </when>
        </choose>
        <if test=" buyDate != '' and buyDate != '0000-00-00' " >
            AND DATE(created_at) = #{buyDate}
        </if>
    </select>

    <!-- 장바구니 목록 수정-->
    <update id="updProduct">
        UPDATE t_purchase_product
        SET
        <if test="categoryPk != '' and categoryPk != null">
            category_pk = #{categoryPk}
        </if>
        <if test="productNm != '' and productNm != null">
            , product_nm = #{productNm}
        </if>
        <choose>
            <when test="memo != '' and memo != null">
                , memo = #{memo}
            </when>
            <otherwise>
                , memo = null
            </otherwise>
        </choose>
        WHERE product_pk = #{productPk}
        AND buying_check = 0
    </update>

    <!-- 구매 확정 처리-->
    <update id="updProductCheck">
        UPDATE t_purchase_product
        SET buying_check = 1
        , buying_date = NOW()
        WHERE product_pk = #{productPk}
        AND buying_check = 0
    </update>

    <!-- 구매 확정 처리 된 상품 숨김 -->
    <update id="updProductCptHide">
        UPDATE t_purchase_product
        SET buying_check = 2
        WHERE product_pk IN
        <foreach collection="productPk" item="productPk" open="(" close=")" separator=",">
            #{productPk}
        </foreach>
        AND buying_check = 1
    </update>

    <!-- 장바구니 목록 삭제 -->
    <delete id="deleteProduct">
        DELETE FROM t_purchase_product
        <where>
            <foreach collection="productPk" item="productPk" separator="OR">
                (product_pk = #{productPk} AND buying_check = 0)
            </foreach>
        </where>
    </delete>
</mapper>